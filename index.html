<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Glasgow SDA Check-in</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 2rem; }
    form, .panel { max-width: 720px; border: 1px solid #ddd; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; }
    label { display: block; font-weight: 600; margin-top: .75rem; }
    input, select, textarea { width: 100%; padding: .6rem .7rem; margin-top: .35rem; border: 1px solid #ccc; border-radius: 6px; }
    button { padding: .6rem .9rem; border: 0; border-radius: 6px; background: #0a7cff; color: white; font-weight: 600; cursor: pointer; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: .75rem; }
    .muted { color: #666; font-size: .9rem; }
    .ok { color: #0b7d37; }
    .err { color: #b00020; }
    ul { padding-left: 1.2rem; }
    code.block { display:block; background:#f7f7f7; padding:.75rem; border-radius:6px; overflow:auto; }
  </style>
</head>
<body>
  <h1>Glasgow SDA Check-in</h1>

  <div class="panel">
    <p class="muted">Connected to Google Apps Script Web App:</p>
    <code class="block" id="endpoint">—</code>
  </div>

  <form id="checkinForm">
    <h2>New Attendance</h2>
    <div class="row">
      <div>
        <label for="name">Full name</label>
        <input id="name" name="name" required />
      </div>
      <div>
        <label for="ageCategory">Age category</label>
        <select id="ageCategory" name="ageCategory" required>
          <option value="adult">Adult</option>
          <option value="youth">Youth</option>
          <option value="child">Child</option>
          <option value="infant">Infant</option>
        </select>
      </div>
    </div>

    <label for="contact">Contact info (optional)</label>
    <input id="contact" name="contact" placeholder="email or phone" />

    <div class="row">
      <div>
        <label for="date">Service date</label>
        <input id="date" name="date" type="date" required />
      </div>
      <div>
        <label for="time">Service time</label>
        <input id="time" name="time" type="time" required />
      </div>
    </div>

    <div class="row">
      <div>
        <label for="isVisitor">Is visitor?</label>
        <select id="isVisitor" name="isVisitor">
          <option value="false">No (member/regular)</option>
          <option value="true">Yes (visitor)</option>
        </select>
      </div>
      <div>
        <label for="visitorStatus">Visitor status</label>
        <select id="visitorStatus" name="visitorStatus">
          <option value="">—</option>
          <option value="first_time">First time</option>
          <option value="returning_visitor">Returning</option>
          <option value="been_a_while">Been a while</option>
        </select>
      </div>
    </div>

    <label for="familyNames">Family members (comma-separated names)</label>
    <input id="familyNames" name="familyNames" placeholder="e.g., Jane Doe, Alex Doe" />

    <div style="margin-top:1rem; display:flex; gap:.5rem;">
      <button type="submit">Submit attendance</button>
      <button type="button" id="btnLoadMembers">Load members</button>
    </div>

    <p id="status" class="muted" style="margin-top:1rem;"></p>
  </form>

  <div class="panel">
    <h2>Known Members (from sheet)</h2>
    <ul id="memberList"></ul>
  </div>

  <script>
    // === CONFIG ===
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzOCSNQczLRu6zLRKq0wSiCLo-8HI_Y11mDEqht0Qh7fbi2hbhO7eb_YayeppJj6pm32Q/exec';
    document.getElementById('endpoint').textContent = SCRIPT_URL;

    // Helpers
    const post = async (payloadObj) => {
      // URL-encoded body to avoid CORS preflight
      const form = new URLSearchParams();
      form.append('payload', JSON.stringify(payloadObj));

      const res = await fetch(SCRIPT_URL, { method: 'POST', body: form });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return await res.json();
    };

    const $status = document.getElementById('status');
    const setStatus = (msg, cls='muted') => {
      $status.className = cls;
      $status.textContent = msg;
    };

    // Load members
    async function loadMembers() {
      setStatus('Loading members…');
      try {
        const result = await post({ action: 'getMembers' });
        if (!result.success) throw new Error(result.error || 'Unknown error');
        const list = document.getElementById('memberList');
        list.innerHTML = '';
        result.members.forEach(m => {
          const li = document.createElement('li');
          li.textContent = m.name + (m.ageCategory ? ` — ${m.ageCategory}` : '');
          list.appendChild(li);
        });
        setStatus(`Loaded ${result.members.length} members.`, 'ok');
      } catch (err) {
        console.error(err);
        setStatus('Failed to load members: ' + err.message, 'err');
      }
    }

    // Submit attendance
    async function submitAttendance(e) {
      e.preventDefault();
      setStatus('Submitting attendance…');

      const name = document.getElementById('name').value.trim();
      const ageCategory = document.getElementById('ageCategory').value;
      const contactInfo = document.getElementById('contact').value.trim();
      const date = document.getElementById('date').value;
      const time = document.getElementById('time').value;
      const isVisitor = document.getElementById('isVisitor').value === 'true';
      const visitorStatus = document.getElementById('visitorStatus').value || '';
      const familyMembers = document.getElementById('familyNames').value
        .split(',')
        .map(s => s.trim())
        .filter(Boolean);

      const attendanceData = {
        timestamp: new Date().toISOString(),
        id: crypto.randomUUID(),
        name,
        ageCategory,
        contactInfo,
        date,
        time,
        isVisitor,
        visitorStatus,
        withFamily: familyMembers.length > 0,
        familyMembers
      };

      const memberData = {
        name,
        ageCategory,
        contactInfo,
        family: familyMembers,
        firstVisit: isVisitor && visitorStatus === 'first_time' ? date : '',
        totalVisits: 1
      };

      try {
        const result = await post({
          action: 'addAttendance',
          attendanceData,
          memberData
        });
        if (!result.success) throw new Error(result.error || 'Unknown error');
        setStatus('Attendance recorded successfully.', 'ok');
        e.target.reset();
        document.getElementById('date').value = new Date().toISOString().slice(0,10);
      } catch (err) {
        console.error(err);
        setStatus('Failed to submit: ' + err.message, 'err');
      }
    }

    document.getElementById('checkinForm').addEventListener('submit', submitAttendance);
    document.getElementById('btnLoadMembers').addEventListener('click', loadMembers);

    // Prefill date/time, attempt member load on start
    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById('date').value = new Date().toISOString().slice(0,10);
      const now = new Date();
      document.getElementById('time').value = String(now.getHours()).padStart(2,'0') + ':' + String(now.getMinutes()).padStart(2,'0');
      loadMembers().catch(()=>{});
    });
  </script>
</body>
</html>
